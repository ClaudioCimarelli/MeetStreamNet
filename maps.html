
<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<title>MeetUP RSVPs Stream Network</title>

<style>
html, body, #map{
        height: 100%;
        width: 100%;
    }
    body{
        margin: 0;
    }
    svg {
        position: relative;
      }

   
</style>
<body>
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
<script src="http://d3js.org/queue.v1.min.js"></script>
 <script src="http://d3js.org/d3.v3.min.js"></script>
 <script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.2/leaflet.js"></script>
 <script src="bower_components/jquery/jquery.min.js"></script>
 <script src="bower_components/must/must.js"></script>
 

<div id="map"></div>



<script>
/* LEAFLET MAP LAYERS */
  var street = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 18,
      minZoom: 2,
      id: 'claudius.ml99a5kb',
      accessToken: 'pk.eyJ1IjoiY2xhdWRpdXMiLCJhIjoiMTg2OWQ5MmZhMGFhZmFkOWI3MjAxNGUxYmQ5MmJkYzEifQ.wHi63c8jHANnb2gds4JjGg'
  });
  var light = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 18,
      minZoom: 2,
      id: 'claudius.momifm3d',
      accessToken: 'pk.eyJ1IjoiY2xhdWRpdXMiLCJhIjoiMTg2OWQ5MmZhMGFhZmFkOWI3MjAxNGUxYmQ5MmJkYzEifQ.wHi63c8jHANnb2gds4JjGg'
  });

  var map = new L.Map("map", {
    center: [41.8858, 12.4822],
    zoom: 2,
    layers: [light]
  });

  var baseMaps = {
    'Light' : light,
    'Street' : street
  }

  L.control.layers(baseMaps).addTo(map);

  /*init SVG Layer */
  map._initPathRoot();
  var svg = d3.select("#map").select("svg"),//d3.select(map.getPanes().overlayPane).append("svg
      g = svg.append("g").attr("class", "leaflet-zoom-hide"); // when the user zooms in or out you need to reset the view

/* code for TopoJson */
  // var transform = d3.geo.transform({
  //         point: projectPoint
  //     });
  // var d3path = d3.geo.path().projection(transform);
  // function projectPoint(x, y) {
  //       var point = map.latLngToLayerPoint(new L.LatLng(y, x));
  //             this.stream.point(point.x, point.y);
  //      };

/* initialize data structures to store events for D3 data nodes*/
 var events_id_list = [];
 var events_list = new Map();
 function addTo_eventList(rsvp){
  if(rsvp.response !== 'yes') return; 
  var id = rsvp.event.event_id;
  var event = events_list.get(id);
  if(event === undefined){
    var x = rsvp.venue.lat;
    var y = rsvp.venue.lon;
    var coords = new L.LatLng(x,y);
    event = {
      'event_id': id,
      'rsvp_yes': 0,
      'lat': coords.lat,
      'lon': coords.lng,
      'time': rsvp.event.time
    }
    events_list.set(id,event);
    events_id_list.push(id);
  }
  event.rsvp_yes++;
  draw(null, events_id_list);
 }
 /* CORE STREAMING part, 
    recall must client to get streamed data of rsvp objects */   
 must.Rsvps(function(rsvp) {
  addTo_eventList(rsvp);
 });
/* function to set up  the drawing of NEW elements ENTERING the dataset */
 function draw(error,collection){ 
   if(error) {
    console.err(error);
    throw error;
   }
   var feature = g.selectAll("circle")
    .data(collection)
    .enter().append("circle");

   map.on("viewreset", update);
   update();

/* update drawing on ZOOM event and new object in dataset */
   function update() {
    feature
    .attr("cx", function(d){
      var x = events_list.get(d).lat;
      var y = events_list.get(d).lon;
      return map.latLngToLayerPoint(new L.LatLng(x,y)).x;
    } )
    .attr("cy", function(d){
      var y = events_list.get(d).lon;
      var x = events_list.get(d).lat;
      return map.latLngToLayerPoint(new L.LatLng(x,y)).y;
    } )        
    .style("stroke", "black")  
    .style("opacity", ".6") 
    .style("fill", "teal")
    .attr("r", function(d){
      var rsvps = events_list.get(d).rsvp_yes;
      return 2*rsvps;
    });
       /*feature.attr("transform", 
         function(d) { 
           var y = d.coordinates[1];
           var x = d.coordinates[0];
           return "translate(" +
                           map.latLngToLayerPoint(new L.LatLng(x,y)).x + "," +
                           map.latLngToLayerPoint(new L.LatLng(x,y)).y + ")";
            });*/
   }
  
 }
  
</script>
</body>
</html>
