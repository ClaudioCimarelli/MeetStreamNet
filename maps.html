
<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<title>MeetUP RSVPs Stream Network</title>

<style>
html, body,
 svg, g, #map{
        height: 100%;
        width: 100%;
    }
    body, svg{
        margin: 0;
    }
   
</style>
<body>
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
<script src="http://d3js.org/queue.v1.min.js"></script>
 <script src="http://d3js.org/d3.v3.min.js"></script>
 <script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.2/leaflet.js"></script>
 <script src="bower_components/jquery/jquery.min.js"></script>
 <script src="bower_components/must/must.js"></script>
 

<div id="map"></div>



<script>

  var map = new L.Map("map", {center: [41.8858, 12.4822], zoom: 6});
  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 12,
      minZoom: 2,
      id: 'claudius.ml99a5kb',
      accessToken: 'pk.eyJ1IjoiY2xhdWRpdXMiLCJhIjoiMTg2OWQ5MmZhMGFhZmFkOWI3MjAxNGUxYmQ5MmJkYzEifQ.wHi63c8jHANnb2gds4JjGg'
  }).addTo(map);
  var svg = d3.select(map.getPanes().overlayPane).append("svg").style("width", "100000").style("height", "100000"),
      g = svg.append("g").attr("class", "leaflet-zoom-hide");


    // when the user zooms in or out you need to reset
          // the view
  // var transform = d3.geo.transform({
  //         point: projectPoint
  //     });
  // var d3path = d3.geo.path().projection(transform);
  // function projectPoint(x, y) {
  //       var point = map.latLngToLayerPoint(new L.LatLng(y, x));
  //             this.stream.point(point.x, point.y);
  //      };

 var rsvps_list = [];
 function insertIn(rsvp){
  rsvps_list.push(rsvp);
  draw(null, rsvps_list);
 }
    
 must.Rsvps(function(rsvp) {
  insertIn(rsvp);
  //draw(null, [rsvp]);
 });

 function draw(error,collection){ 
   if(error) {
    console.err(error);
    throw error;
   }
   var feature = g.selectAll("circle")
    .data(collection, function(d){
      d.radius = 1;
      return d.event.event_id;
    })
    .enter().append("circle");
   map.on("viewreset", update);
   update();

   function update() {
    feature
    .attr("cx", function(d){
      if(d.venue){ 
          var y = d.venue.lon;
          var x = d.venue.lat;
          return map.latLngToLayerPoint(new L.LatLng(x,y)).x;
        }
        else{
          var y = d.group.group_lon;
          var x = d.group.group_lat;
          return map.latLngToLayerPoint(new L.LatLng(x,y)).x;
        }
    } )
    .attr("cy", function(d){ 
      if(d.venue){ 
          var y = d.venue.lon;
          var x = d.venue.lat;
          return map.latLngToLayerPoint(new L.LatLng(x,y)).y;
        }
        else{
          var y = d.group.group_lon;
          var x = d.group.group_lat;
          return map.latLngToLayerPoint(new L.LatLng(x,y)).y;
        }
    } )        
    .style("stroke", "black")  
    .style("opacity", ".6") 
    .style("fill", "teal")
    .attr("r", 10);
       /*feature.attr("transform", 
         function(d) { 
           var y = d.coordinates[1];
           var x = d.coordinates[0];
           return "translate(" +
                           map.latLngToLayerPoint(new L.LatLng(x,y)).x + "," +
                           map.latLngToLayerPoint(new L.LatLng(x,y)).y + ")";
            });*/
   }
  
 }
  
</script>
</body>
</html>
